# This macro is for MPC hotend control. Adapt your slicer accordingly 

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material
variable_filament_table:
    ## Update this table to adjust material settings
    {
        ## ( density, heat capacity )  # suggested heat capacity range
        "PLA"       : ( 1.25, 2.20 ),  # 1.80 - 2.20
        "PETG"      : ( 1.27, 2.20 ),  # 1.70 - 2.20
        "PC+ABS"    : ( 1.15, 2.20 ),  # 1.50 - 2.20
        "ABS"       : ( 1.06, 2.40 ),  # 1.25 - 2.40
        "ABS-GF"    : ( 1.08, 2.40 ),  # 1.25 - 2.40
        "ASA"       : ( 1.07, 2.10 ),  # 1.30 - 2.10
        "PA6"       : ( 1.12, 2.50 ),  # 2.00 - 2.50
        "PA"        : ( 1.15, 2.50 ),  # 2.00 - 2.50
        "PA-CF"     : ( 1.09, 2.50 ),
        "PC"        : ( 1.20, 1.90 ),  # 1.10 - 1.90
        "TPU"       : ( 1.21, 2.00 ),  # 1.50 - 2.00
        "TPU-90A"   : ( 1.15, 2.00 ),  # 1.50 - 2.00
        "TPU-95A"   : ( 1.22, 2.00 ),  # 1.50 - 2.00
        "ABS-CF"    : ( 1.11, 2.40 ),  # 1.25 - 2.40
        "ASA-CF"    : ( 1.11, 2.10 ),  # 1.30 - 2.10
        "PA6-CF"    : ( 1.19, 2.50 ),  # 2.00 - 2.50
        "PC+ABS-CF" : ( 1.22, 2.20 ),  # 1.50 - 2.20
        "PC+CF"     : ( 1.36, 1.90 ),  # 1.10 - 1.90
        "PLA-CF"    : ( 1.29, 2.20 ),  # 1.80 - 2.20
        "PETG-CF"   : ( 1.30, 2.20 ),  # 1.70 - 2.20
    }
gcode:
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    {% set extruder_config = printer.configfile.settings[heater] %}

    {% if material in filament_table %}
        {% set (density, heat_capacity) = filament_table[material] %}

        RESPOND PREFIX=üî• MSG="Configured {heater} MPC for {material}. Density: {density}, Heat Capacity: {heat_capacity}"
    {% else %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity=extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=üî• MSG="Unknown material '{material}', using default mpc parameters for {heater}"
    {% endif %}

    MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}

# This macro is to adjust Z offset based on material. Adjust the table below to update your offsets
# These offsets will be added to any offset already applied

# You should add this macro to your PRINT_START and SLICER:
# In your PRINT_START call this macro after any initial z offset calculations:
### _SET_FILAMENT_OFFSET MATERIAL={params.MATERIAL}

# In your slicer, pass the material type in the machine start G-code:
### MATERIAL=[filament_type[initial_extruder]]

[gcode_macro _SET_FILAMENT_OFFSET]
description: Additional Z offset adjustments for a given material
variable_filament_table:
    ## Update this table to adjust material based Z offset
    {
        ## ( additional z_offset, #future settings here )
        "PLA"       : ( 0.02 ),  
        "PETG"      : ( 0 ),  
        "PC+ABS"    : ( 0 ),  
        "ABS"       : ( -0.004 ), 
        "ABS-GF"    : ( -0.004 ),  
        "ASA"       : ( 0.022 ),  
        "PA6"       : ( 0 ),  
        "PA"        : ( 0.03 ),
        "PA-CF"     : ( 0.03 ),  
        "PC"        : ( 0 ),  
        "TPU"       : ( 0 ),  
        "TPU-90A"   : ( 0 ),  
        "TPU-95A"   : ( 0 ),  
        "ABS-CF"    : ( 0 ),  
        "ASA-CF"    : ( 0 ),  
        "PA6-CF"    : ( 0.03 ),  
        "PC+ABS-CF" : ( 0 ),  
        "PC+CF"     : ( 0 ),  
        "PLA-CF"    : ( 0 ),  
        "PETG-CF"   : ( 0 ),  
    }
gcode:
    {% set material = params.MATERIAL | upper %}
    {% set current_offset = printer.gcode_move.homing_origin.z %}
    
    {% if material in filament_table %}
        {% set (additional_z_offset) = filament_table[material] %}
        {% set (final_offset) = (additional_z_offset) + current_offset %}
        RESPOND PREFIX=‚ÜïÔ∏è MSG="Adjusting Z offset for {material} by {additional_z_offset}. Total Z offset={final_offset}"  
    {% else %}      
        {% set additional_z_offset = 0 %}
        RESPOND PREFIX=‚ÜïÔ∏è MSG="‚ÄºÔ∏è Unknown material '{material}', not adjusting Z offset. üëÄ the print to see if any additional adjustments are needed!"
    {% endif %}
    
    SET_GCODE_OFFSET Z_ADJUST={additional_z_offset}
    